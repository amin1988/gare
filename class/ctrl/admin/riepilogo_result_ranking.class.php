<?phpif (!defined("_BASEDIR_"))    exit();session_start();include_model("Categoria", "Gara", "Ranking", "IscrittoIndividuale", "Utente", "RankingLog");include_controller("resp/riepilogo_individuale");class GareEsterneRiepilogoRisCtrl{    private $gare;    private $array_eventi = NULL;    private $ranking = NULL;    private $elenco_categorie = NULL;    private $categorie = NULL;    private $id_gara = 0;    public function __construct($id_gara, $id_kat_selezionato, $nome_atleta, $cognome_atleta, $numero_tesserato)    {        $this->id_gara = $id_gara;        $this->ranking = new Ranking();        $this->array_eventi = $this->ranking->getRankingEventi();        $iscr = IscrittoIndividuale::listaGara($id_gara);        $this->caricaCategorie($iscr);               $this->caricaAtleti($iscr);        $this->elenco_categorie = Categoria::elenco();    }            private function  convalidaGaraRisCtrl()    {        $this->ranking->convalidaRisEsterni($this->id_gara);    }    private function eliminaRisCtrl($array_dati_con_risultati)    {        $tabella = "ranking_risultati";        $array_lista_campi = "";        if (!empty($array_dati_con_risultati))        {            for ($i = 0; $i < count($array_dati_con_risultati); $i++)            {                $atleta_con_risultato = $array_dati_con_risultati[$i];                $dati = array();                $dati['id_gara'] = $atleta_con_risultato['id_gara'];                //$campi = array_keys($atleta_con_risultato);                //$valori = array_values($atleta_con_risultato);                $where_condition = " WHERE id_atleta = ".$atleta_con_risultato['id_atleta']. " AND ". "kategoria = ". $atleta_con_risultato['kategoria']. " AND ". "id_gara = ".$this->id_gara;               $row_eliminato = $this->ranking->eliminaRankingEventiEsterni('ranking_risultati', $where_condition);                $id_ins = 0;                if ($row_eliminato)                    $dati['id_ranking_risultati'] = $atleta_con_risultato['classificato'];                $dati['id_utente'] = Utente::getIdAccesso();                $dati['descrizione'] = "cancellato";                $dati['kategoria'] = $atleta_con_risultato['kategoria'];                $dati['classificato'] = $atleta_con_risultato['classificato'];                                $log = new RankingLog();                $log_inserito = $log->insertLogRanking($log->setDati($dati));            }        }    }    public function getIscritti()    {        return $this->iscritti;    }    /**     * @param Iscritto[] $iscr     */    public function caricaCategorie($iscr)    {        $idcats = array();        if (count($iscr) == 0)        {            $this->categorie = array();        } else        {            foreach ($iscr as $i)            {                /* @var $i Iscritto */                $idc = $i->getCategoria();                $ida = $i->getAccorpamento();                if (!is_null($ida))                {                    if (!isset($this->catcount[$idc]))                    {                        $this->catcount[$idc] = 0;                        $idcats[$idc] = $idc;                    }                    $idc = $ida;                }                if (!isset($this->catcount[$idc]))                {                    $this->catcount[$idc][0] = 1;                    $idcats[$idc] = $idc;                } else                {                    $this->catcount[$idc][0] ++;                }                if ($i->isSeparato())                {                    if (!isset($this->catcount[$idc][$i->getPool()]))                        $this->catcount[$idc][$i->getPool()] = 1;                    else                        $this->catcount[$idc][$i->getPool()] ++;                }            }            $this->categorie = Categoria::lista($idcats);        }        //uksort($this->categorie, array($this, "compareCat"));        uasort($this->categorie, array("Categoria", "compare"));    }    /**     * @param IscrittoIndividuale[] $iscr     */    private function caricaAtleti($iscr, $array_parametri_ricerca = NULL)    {        $socid = array();        $this->iscritti = array();                  foreach ($iscr as $value)        {            /* @var $value IscrittoIndividuale */            $ida = $value->getAtleta();            $ids = $value->getSocieta();            $socid[$ids][$ida] = $ida;            $id_categoria = $value->getCategoriaFinale();            $atleta_convalidato = $this->ranking->riepiloGaraEsternoPresenze($ida, $this->id_gara, $id_categoria);            if ($atleta_convalidato) // se non è stato già inserito            {                $atleta = new AtletaRanking("tesserati", $ida);                $atleta->carica();                $cognome = strtolower($atleta->getCognome());                $nome = strtolower($atleta->getNome());                if (count($array_parametri_ricerca) == 0)                {                    $zero_selez = true;                    $this->iscritti[$id_categoria][$value->getPool()][] = $value;                } else if (count($array_parametri_ricerca) == 1)                {                    if (isset($array_parametri_ricerca['nome']) && $array_parametri_ricerca['nome'] == $nome)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if (isset($array_parametri_ricerca['cognome']) && $array_parametri_ricerca['cognome'] == $cognome)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if (isset($array_parametri_ricerca['id_kat_selezionato']) && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if (isset($array_parametri_ricerca['numero_tesserato']) && $array_parametri_ricerca['numero_tesserato'] == $ida)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                } else if (count($array_parametri_ricerca) == 2)                {                    if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['cognome'] == $cognome)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['numero_tesserato'] == $ida)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['numero_tesserato'] == $ida)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['numero_tesserato'] == $ida && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                } else if (count($array_parametri_ricerca) == 3)                {                    //escluso categoria                    if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['numero_tesserato'] == $ida)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                    // escluso num tesserato                    else if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                    //escluso cognome                    else if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['numero_tesserato'] == $ida && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                    //escluso nome                    else if ($array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['numero_tesserato'] == $ida && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                } else if (count($array_parametri_ricerca) == 4)                {                    //controlla tutto                    if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['numero_tesserato'] == $ida && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                }            }        }        foreach ($this->iscritti as $idc => $pools)        {            foreach (array_keys($pools) as $pool)                usort($this->iscritti[$idc][$pool], array($this, "compareIsc"));        }    }    public function allCategorie()    {        return $this->categorie;    }    public function redirect($path)    {        print '<META HTTP-EQUIV="refresh" CONTENT="0; URL=' . $path . '">';    }    public function getEventi()    {        return $this->array_eventi;    }    public function getNomeGara($id_gara)    {        return $this->ranking->getNomeGara($id_gara);    }    public function getGare()    {        return $this->gare;    }}