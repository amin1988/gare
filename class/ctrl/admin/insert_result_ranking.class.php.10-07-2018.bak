<?phpif (!defined("_BASEDIR_"))    exit();session_start();include_model("Categoria", "Gara", "Ranking", "IscrittoIndividuale", "Utente", "RankingLog");include_controller("resp/riepilogo_individuale");class GareEsterneInsertRisCtrl{    private $gare;    private $array_eventi = NULL;    private $ranking = NULL;    private $elenco_categorie = NULL;    private $categorie = NULL;    private $id_gara = 0;    public function __construct($id_gara, $id_kat_selezionato, $nome_atleta, $cognome_atleta, $numero_tesserato)    {        $this->id_gara = $id_gara;        $this->ranking = new Ranking();        $this->array_eventi = $this->ranking->getRankingEventi();        $classificato_post = !empty($_POST['classificato']) ? $_POST['classificato'] : NULL;        $array_tessetati = array();        if (!empty($classificato_post))        {            foreach ($classificato_post as $tess => $array_kat)            {                $classificato = $elem[0];                foreach ($array_kat as $id_kat=>$valore)                {                    if (empty($valore))                    continue;                                         $array_tessetati[$tess][$id_kat] = $valore;                }                           }        }        $array_dati_con_risultati = array();        if (isset($_POST['processa']) && $_POST['processa'] == "Inserisci")        {            if (!empty($_POST['array_dati_eventi']) && !empty($_POST['classificato']))            {                for ($i = 0; $i < count($_POST['array_dati_eventi']); $i++)                {                    $evento_post_string = $_POST['array_dati_eventi'][$i];                    $evento_post_obj = json_decode($evento_post_string, true);                    $id_tesserato = $evento_post_obj['id_atleta'];                    $id_kategoria = $evento_post_obj['kategoria'];                    if (array_key_exists($id_tesserato, $array_tessetati))                    {                        //prendo il risultato di solo quello che è stato digitato                        $classificato_digitato = $array_tessetati[$id_tesserato][$id_kategoria];                        if (!empty($classificato_digitato)  )                        {                            $evento_post_obj['classificato'] = $classificato_digitato;                            $evento_post_obj['id_gara'] = $this->id_gara;                            $array_dati_con_risultati [] = $evento_post_obj;                        }                    }                }                $this->insertRisCtrl($array_dati_con_risultati);            }        }        $iscr = IscrittoIndividuale::listaGara($id_gara);        $this->caricaCategorie($iscr);        $array_parametri_ricerca = array();        if (!empty($id_kat_selezionato))        {            $array_parametri_ricerca['id_kat_selezionato'] = $id_kat_selezionato;        }        if (!empty($nome_atleta))        {            $array_parametri_ricerca['nome'] = strtolower($nome_atleta);        }        if (!empty($cognome_atleta))        {            $array_parametri_ricerca['cognome'] = strtolower($cognome_atleta);        }        if (!empty($numero_tesserato))        {            $array_parametri_ricerca['numero_tesserato'] = $numero_tesserato;        }        $this->caricaAtleti($iscr, $array_parametri_ricerca);        $this->elenco_categorie = Categoria::elenco();    }    private function insertRisCtrl($array_dati_con_risultati)    {        $tabella = "ranking_risultati";        $array_lista_campi = "";        for ($i = 0; $i < count($array_dati_con_risultati); $i++)        {            $atleta_con_risultato = $array_dati_con_risultati[$i];            $dati = array();            $dati['id_gara'] = $atleta_con_risultato['id_gara'];            $campi = array_keys($atleta_con_risultato);            $valori = array_values($atleta_con_risultato);            $row_inserito = $this->ranking->insertRankingEventiEsterni('ranking_risultati', $campi, $valori, $this->id_gara);            $id_ins = 0;            if ($row_inserito)                $dati['id_ranking_risultati'] = $this->ranking->getLastIdInsert();            $dati['id_utente'] = Utente::getIdAccesso();            $dati['descrizione'] = "inserito";            $log = new RankingLog();            $log_inserito = $log->insertLogRanking($log->setDati($dati));        }    }    public function getIscritti()    {        return $this->iscritti;    }    /**     * @param Iscritto[] $iscr     */    public function caricaCategorie($iscr)    {        $idcats = array();        if (count($iscr) == 0)        {            $this->categorie = array();        } else        {            foreach ($iscr as $i)            {                /* @var $i Iscritto */                $idc = $i->getCategoria();                $ida = $i->getAccorpamento();                if (!is_null($ida))                {                    if (!isset($this->catcount[$idc]))                    {                        $this->catcount[$idc] = 0;                        $idcats[$idc] = $idc;                    }                    $idc = $ida;                }                if (!isset($this->catcount[$idc]))                {                    $this->catcount[$idc][0] = 1;                    $idcats[$idc] = $idc;                } else                {                    $this->catcount[$idc][0] ++;                }                if ($i->isSeparato())                {                    if (!isset($this->catcount[$idc][$i->getPool()]))                        $this->catcount[$idc][$i->getPool()] = 1;                    else                        $this->catcount[$idc][$i->getPool()] ++;                }            }            $this->categorie = Categoria::lista($idcats);        }        //uksort($this->categorie, array($this, "compareCat"));        uasort($this->categorie, array("Categoria", "compare"));    }    /**     * @param IscrittoIndividuale[] $iscr     */    private function caricaAtleti($iscr, $array_parametri_ricerca = NULL)    {        $socid = array();        $this->iscritti = array();        foreach ($iscr as $value)        {            /* @var $value IscrittoIndividuale */            $ida = $value->getAtleta();            $ids = $value->getSocieta();            $socid[$ids][$ida] = $ida;            $id_categoria = $value->getCategoriaFinale();            $atleta_gia_inserito = $this->ranking->atletaGiaInserito($ida, $this->id_gara, $id_categoria);            if (!$atleta_gia_inserito) // se non è stato già inserito            {                $atleta = new AtletaRanking("tesserati", $ida);                $atleta->carica();                $cognome = strtolower($atleta->getCognome());                $nome = strtolower($atleta->getNome());                if (count($array_parametri_ricerca) == 0)                {                    $zero_selez = true;                    $this->iscritti[$id_categoria][$value->getPool()][] = $value;                } else if (count($array_parametri_ricerca) == 1)                {                    if (isset($array_parametri_ricerca['nome']) && $array_parametri_ricerca['nome'] == $nome)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if (isset($array_parametri_ricerca['cognome']) && $array_parametri_ricerca['cognome'] == $cognome)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if (isset($array_parametri_ricerca['id_kat_selezionato']) && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if (isset($array_parametri_ricerca['numero_tesserato']) && $array_parametri_ricerca['numero_tesserato'] == $ida)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                } else if (count($array_parametri_ricerca) == 2)                {                    if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['cognome'] == $cognome)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['numero_tesserato'] == $ida)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['numero_tesserato'] == $ida)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    } else if ($array_parametri_ricerca['numero_tesserato'] == $ida && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                } else if (count($array_parametri_ricerca) == 3)                {                    //escluso categoria                    if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['numero_tesserato'] == $ida)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                    // escluso num tesserato                    else if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                    //escluso cognome                    else if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['numero_tesserato'] == $ida && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                    //escluso nome                    else if ($array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['numero_tesserato'] == $ida && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                } else if (count($array_parametri_ricerca) == 4)                {                    //controlla tutto                    if ($array_parametri_ricerca['nome'] == $nome && $array_parametri_ricerca['cognome'] == $cognome && $array_parametri_ricerca['numero_tesserato'] == $ida && $array_parametri_ricerca['id_kat_selezionato'] == $id_categoria)                    {                        $this->iscritti[$id_categoria][$value->getPool()][] = $value;                    }                }            }        }        foreach ($this->iscritti as $idc => $pools)        {            foreach (array_keys($pools) as $pool)                usort($this->iscritti[$idc][$pool], array($this, "compareIsc"));        }    }    public function allCategorie()    {        return $this->categorie;    }    public function redirect($path)    {        print '<META HTTP-EQUIV="refresh" CONTENT="0; URL=' . $path . '">';    }    public function getEventi()    {        return $this->array_eventi;    }    public function getNomeGara($id_gara)    {        return $this->ranking->getNomeGara($id_gara);    }    public function getGare()    {        return $this->gare;    }}